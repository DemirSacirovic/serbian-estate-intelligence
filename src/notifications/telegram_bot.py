"""
Telegram Bot za Serbian Estate Intelligence
≈†alje instant notifikacije o dobrim ponudama
"""
import os
import json
import logging
from datetime import datetime
from typing import Dict, List
import requests

logger = logging.getLogger(__name__)


class TelegramNotifier:
    """Telegram bot za notifikacije"""
    
    def __init__(self, bot_token: str = None, chat_id: str = None):
        self.bot_token = bot_token or os.getenv('TELEGRAM_BOT_TOKEN')
        self.chat_id = chat_id or os.getenv('TELEGRAM_CHAT_ID')
        self.base_url = f"https://api.telegram.org/bot{self.bot_token}"
        
    def send_deal_alert(self, deal: Dict):
        """≈†alje alert za pojedinaƒçnu ponudu"""
        message = self._format_deal_message(deal)
        
        # Po≈°alji tekst
        self._send_message(message, parse_mode='Markdown')
        
        # Po≈°alji lokaciju ako je dostupna
        if deal.get('coordinates'):
            self._send_location(
                deal['coordinates']['lat'],
                deal['coordinates']['lon']
            )
    
    def send_daily_summary(self, deals: List[Dict], stats: Dict):
        """≈†alje dnevni izve≈°taj"""
        message = self._format_daily_summary(deals, stats)
        self._send_message(message, parse_mode='Markdown')
    
    def send_price_drop_alert(self, property_data: Dict, old_price: float, new_price: float):
        """≈†alje alert o padu cene"""
        drop_percent = ((old_price - new_price) / old_price) * 100
        
        message = f"""
üîª *PAD CENE!*

*{property_data['title']}*
üìç {property_data['city']}, {property_data.get('municipality', 'Nepoznato')}

üí∞ Stara cena: ‚Ç¨{old_price:,.0f}
üí∏ Nova cena: ‚Ç¨{new_price:,.0f}
üìâ Pad: {drop_percent:.0f}% (‚Ç¨{old_price - new_price:,.0f})

üè† {property_data.get('area', '?')}m¬≤, {property_data.get('rooms', '?')} soba

üîó [Pogledaj oglas]({property_data['link']})

‚ö° *Ovo je prilika - cena je pala!*
"""
        
        self._send_message(message, parse_mode='Markdown')
    
    def send_desperate_seller_alert(self, seller_data: Dict):
        """≈†alje alert o oƒçajnom prodavcu"""
        message = f"""
üö® *OƒåAJAN PRODAVAC!*

*{seller_data['property']['title']}*
üìç {seller_data['property'].get('location', 'Nepoznato')}

üî• Desperation Score: {seller_data['desperation_score']}/100
üìÖ Na tr≈æi≈°tu: {seller_data['days_on_market']} dana
üìâ Spu≈°tao cenu: {seller_data['total_drops']} puta

üí∞ Trenutna cena: ‚Ç¨{seller_data['current_price']:,.0f}
üí° Preporuƒçena ponuda: ‚Ç¨{seller_data['recommendation']['suggested_offer']:,.0f}

üìã *Argumenti za pregovaranje:*
"""
        
        for point in seller_data['recommendation']['talking_points']:
            message += f"‚Ä¢ {point}\n"
        
        message += f"\nüéØ Strategija: *{seller_data['recommendation']['strategy']}*"
        
        if seller_data['property'].get('link'):
            message += f"\n\nüîó [Pogledaj oglas]({seller_data['property']['link']})"
        
        self._send_message(message, parse_mode='Markdown')
    
    def _format_deal_message(self, deal: Dict) -> str:
        """Formatira poruku za ponudu"""
        prop = deal['property']
        estimate = deal.get('estimate', {})
        
        # Emoji na osnovu ratinga
        rating_emojis = {
            'AAA': 'üåüüåüüåü',
            'AA': 'üåüüåü',
            'A': 'üåü',
            'B': '‚≠ê',
            'C': 'üí´'
        }
        
        rating = estimate.get('investment_rating', 'B')
        emoji = rating_emojis.get(rating, '‚≠ê')
        
        message = f"""
üè† *NOVA PRILIKA!* {emoji}

*{prop['title']}*
üìç {prop['city']}, {prop.get('municipality', 'Nepoznato')}

üí∞ Cena: ‚Ç¨{prop['price']:,.0f}
üìä Procena: ‚Ç¨{estimate.get('estimated_value', 0):,.0f}
üìâ Popust: {estimate.get('discount', 0)*100:.0f}% (‚Ç¨{deal.get('savings', 0):,.0f})

üìè Povr≈°ina: {prop.get('area', '?')}m¬≤
üè† Sobe: {prop.get('rooms', '?')}
üè¢ Sprat: {prop.get('floor', '?')}/{prop.get('total_floors', '?')}

‚≠ê Rating: *{rating}*
üìà Confidence: {estimate.get('confidence_score', 0)}%
"""
        
        # Dodaj razloge ako je dobra ponuda
        if estimate.get('discount', 0) > 0.1:
            message += "\nüí° *Za≈°to je dobra ponuda:*\n"
            
            if 'found_on' in deal and len(deal['found_on']) > 1:
                message += f"‚Ä¢ Pronaƒëena na {len(deal['found_on'])} sajtova\n"
            
            trend = estimate.get('market_trend', {})
            if trend.get('direction') == 'rapidly rising':
                message += f"‚Ä¢ Brzi rast tr≈æi≈°ta ({trend.get('yearly_change', 0)*100:.0f}% godi≈°nje)\n"
        
        # ROI procena
        monthly_rent = prop['price'] * 0.004
        yearly_roi = (monthly_rent * 12) / prop['price'] * 100
        message += f"\nüí∏ Procena izdavanja: ‚Ç¨{monthly_rent:.0f}/mesec ({yearly_roi:.1f}% ROI)"
        
        # Link
        if prop.get('link'):
            message += f"\n\nüîó [Pogledaj oglas]({prop['link']})"
        
        # Call to action
        if estimate.get('discount', 0) > 0.15:
            message += "\n\n‚ö° *HITNO POGLEDAJ - ODLIƒåNA PRILIKA!*"
        
        return message
    
    def _format_daily_summary(self, deals: List[Dict], stats: Dict) -> str:
        """Formatira dnevni izve≈°taj"""
        message = f"""
üìä *DNEVNI IZVE≈†TAJ*
{datetime.now().strftime('%d.%m.%Y')}

üîç Skenirano: {stats.get('total_scanned', 0)} oglasa
‚úÖ Pronaƒëeno: {len(deals)} dobrih ponuda
üí∞ Proseƒçan popust: {stats.get('avg_discount', 0)*100:.0f}%

üèÜ *TOP 3 PONUDE:*
"""
        
        for i, deal in enumerate(deals[:3], 1):
            prop = deal['property']
            est = deal.get('estimate', {})
            
            message += f"""
{i}. *{prop['title'][:40]}...*
   üìç {prop['city']}, {prop.get('municipality', '?')}
   üí∞ ‚Ç¨{prop['price']:,.0f} ({est.get('discount', 0)*100:.0f}% popust)
   ‚≠ê {est.get('investment_rating', 'B')}
"""
        
        # Tr≈æi≈°ni uvidi
        message += f"""

üìà *TR≈ΩI≈†NI UVIDI:*
‚Ä¢ Najbolja lokacija: {stats.get('best_location', 'N/A')}
‚Ä¢ Najbr≈æi rast: {stats.get('fastest_growing', 'N/A')}
‚Ä¢ Preporuka: {stats.get('recommendation', 'Nastavi praƒáenje')}
"""
        
        return message
    
    def _send_message(self, text: str, parse_mode: str = None):
        """≈†alje poruku preko Telegram API"""
        if not self.bot_token or not self.chat_id:
            logger.warning("Telegram kredencijali nisu pode≈°eni")
            print("\nüì± TELEGRAM PREVIEW:")
            print(text)
            return
        
        url = f"{self.base_url}/sendMessage"
        data = {
            'chat_id': self.chat_id,
            'text': text
        }
        
        if parse_mode:
            data['parse_mode'] = parse_mode
        
        try:
            response = requests.post(url, json=data)
            if response.status_code == 200:
                logger.info("Telegram poruka poslata uspe≈°no")
            else:
                logger.error(f"Telegram gre≈°ka: {response.text}")
        except Exception as e:
            logger.error(f"Gre≈°ka pri slanju Telegram poruke: {str(e)}")
    
    def _send_location(self, latitude: float, longitude: float):
        """≈†alje lokaciju na mapi"""
        if not self.bot_token or not self.chat_id:
            return
        
        url = f"{self.base_url}/sendLocation"
        data = {
            'chat_id': self.chat_id,
            'latitude': latitude,
            'longitude': longitude
        }
        
        try:
            requests.post(url, json=data)
        except Exception as e:
            logger.error(f"Gre≈°ka pri slanju lokacije: {str(e)}")
    
    def setup_webhook(self, webhook_url: str):
        """Postavlja webhook za primanje komandi"""
        url = f"{self.base_url}/setWebhook"
        data = {'url': webhook_url}
        
        response = requests.post(url, json=data)
        if response.status_code == 200:
            logger.info("Webhook postavljen uspe≈°no")
            return True
        else:
            logger.error(f"Gre≈°ka pri postavljanju webhook: {response.text}")
            return False
    
    @staticmethod
    def get_setup_instructions() -> str:
        """Vraƒáa instrukcije za setup"""
        return """
üì± TELEGRAM BOT SETUP:

1. Otvori Telegram i pronaƒëi @BotFather
2. Po≈°alji /newbot
3. Daj ime botu (npr. Serbian Estate Bot)
4. Daj username (npr. serbian_estate_bot)
5. Kopiraj TOKEN koji dobije≈°

6. Pokreni bota i po≈°alji mu bilo koju poruku
7. Otvori: https://api.telegram.org/bot<TOKEN>/getUpdates
8. Pronaƒëi "chat":{"id": BROJ} - to je tvoj CHAT_ID

9. Dodaj u .env:
   TELEGRAM_BOT_TOKEN=tvoj_token_ovde
   TELEGRAM_CHAT_ID=tvoj_chat_id_ovde

10. Testiraj:
    python3 src/notifications/telegram_bot.py
"""


# Test
if __name__ == "__main__":
    print(TelegramNotifier.get_setup_instructions())
    
    # Test notifier
    notifier = TelegramNotifier()
    
    # Test deal
    test_deal = {
        'property': {
            'title': 'Odliƒçan stan na Vraƒçaru, hitna prodaja',
            'price': 120000,
            'city': 'Beograd',
            'municipality': 'Vraƒçar',
            'area': 65,
            'rooms': 2,
            'floor': 3,
            'total_floors': 5,
            'link': 'https://example.com/stan-vracar'
        },
        'estimate': {
            'estimated_value': 150000,
            'discount': 0.20,
            'investment_rating': 'AAA',
            'confidence_score': 85
        },
        'savings': 30000,
        'found_on': ['halooglasi', '4zida', 'nekretnine.rs']
    }
    
    print("\nüîî ≈†aljem test notifikaciju...")
    notifier.send_deal_alert(test_deal)
    
    # Test desperate seller
    test_seller = {
        'property': {
            'title': 'Stan NBG blok 45',
            'location': 'Novi Beograd, Blok 45'
        },
        'desperation_score': 85,
        'days_on_market': 120,
        'total_drops': 4,
        'current_price': 95000,
        'recommendation': {
            'suggested_offer': 80000,
            'strategy': 'AGRESIVNO - Prodavac je vrlo oƒçajan',
            'talking_points': [
                'Nekretnina je na tr≈æi≈°tu veƒá 120 dana',
                'Cena je veƒá spu≈°tana 4 puta',
                'Ukupno spu≈°tanje cene: ‚Ç¨25,000'
            ]
        }
    }
    
    print("\nüö® ≈†aljem alert o oƒçajnom prodavcu...")
    notifier.send_desperate_seller_alert(test_seller)